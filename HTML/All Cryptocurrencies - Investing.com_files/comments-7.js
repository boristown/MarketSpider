// File: comments-socket.js
loader([{type:"$",value:".js-commentary"},"socketConnector","components","getCookie","setCookie"]).ready(function(a,b,c,d,e){function f(a){return Q.addClass(a?"block":"displayNone").removeClass(a?"displayNone":"block")}function g(){if(!F){var a=K.find(".js-templates");F=$(a.text().replace(/ src=/g," data-src=")),a.remove()}return F}function h(a){return H[a]||(H[a]=new Template(g().filter("#"+a).html())),H[a]}function i(a,b){var c=$(a),d=c.find(".js-content");b=b||c.attr("data-comment-id"),G[b]={id:b,$el:c,$content:d,$text:d.find(".js-text"),$date:d.find(".js-date")}}function j(){M++,J.text(M)}function k(a){return a.replace(/\n/g,".")}function l(a){var b=1e3*Number(a.timestamp),c=p(b);return{commentID:a.ID,username:a.username||"username",userLink:a.userLink,usernameAlt:a.usernameAlt,userImage:a.userImage,dateFormat:o(b),dateFormatted:c,dateLabel:c,dateTitle:"",commentImage:a.commentImage,commentImageSmall:a.commentImageSmall,commentContent:{value:k(a.commentContent),unEscape:!0},commentLink:a.commentLink,commentAlt:a.commentAlt,isMasterUser:Number(a.isMasterUser),isCommentByAuthor:Number(a.isCommentByAuthor)}}function m(a,b){var c=(""+b.userLink).match(/\/members\/(\d+)/);c&&(a.attr("data-user-id",c[1]),a.find(".js-reply-btn").attr("data-to-user-id",c[1])),b.commentImage||a.find(".js-text-wrapper").removeClass("withImage").find(".js-comment-chart").remove(),b.isMasterUser&&a.find(".js-not-master-user").remove(),b.isCommentByAuthor||a.find(".js-comment-by-author").remove(),b.userLink||a.find(".js-user-link").each(function(){var a=$(this),b=a.html(),c=a.attr("class").replace("js-user-link").trim();c.length>0?a.replaceWith($("<span />").attr("class",c).html(b)):a.replaceWith(b)}),a.find("img").each(function(){var a=$(this);a.attr("src",a.attr("data-src"))})}function n(a,b){a=l(a);var c=h(b).reset(a).get(!0);return m(c,a),C(a.userLink).is(uid)&&c.find(".js-block-option").remove(),c.addClass("newComment").one("mouseenter",function(){c.removeClass("newComment")}),c}function o(a){return(a?new Date(Number(a)):new Date).toJSON().replace("T"," ").split(".")[0]}function p(a){var b=new Date(Number(a));return[b.toDateString().split(" ").slice(1).join(", ").replace(", "," "),b.toTimeString().split("+")[0]].join(" ")}function q(a){var b=G[a.ID],c=l(a);b.$text.text(c.commentContent),b.$date.attr("comment-date",c.dateFormat),m(b.$el,c)}function r(a,b){b?b.append(a):K.prepend(a),window.bindAllCommentSaveActions(a.find(".js-save-item-btn")),window.bindLikeDislikeAction(a.find(".js-like-dislike-box")),window.blockButtonClickHandlerOuter(a)}function s(a,b,c){truncateIfNeeded(b.find(".js-text")),i(b,a),r(b,c),window.bindAllCommentSideActions(),window.bindReplyAction(b)}function t(a,b,c,d){var e={id:a,$comment:b,$parent:c};c&&d?(P[d]||(P[d]=[]),P[d].push(e)):(O.push(e),1===O.length&&f(!0),R.text(O.length)),i(b,a)}function u(a){O=O.filter(function(b){return b.id!==a}),f(!!O.length),R.text(O.length)}function v(a){var b=n(a,"comment");N?s(a.ID,b):t(a.ID,b)}function w(){var a,b,c=this,d=P[c.id];if(c.$showMore&&(c.$showMore.remove(),delete c.$showMore),d&&d.length){for(b=0;b<d.length;b++)a=d[b],(!G[a.id]||G[a.id].$el.is(a.$comment)&&!a.$parent.find(a.$comment).length)&&r(a.$comment,a.$parent);d.length=0}}function x(a){P[a.id]&&(a.$showMore||(a.$showMore=h("show-more-replies").get(!0),a.$showMoreAmount=a.$showMore.find(".js-amount"),a.$showMore.click(w.bind(a)).appendTo(a.$el)),a.$showMoreAmount.text(P[a.id].length))}function y(){var a,b;for(b=0;b<O.length;b++)a=O[b],r(a.$comment),P[a.id]&&w.apply(G[a.id]);K.prepend(f(!1)),window.bindAllCommentSideActions(),O=[]}function z(){var a;for(a in P)w.apply(G[a]);K.prepend(f(!1)),window.bindAllCommentSideActions()}function A(a){if(G[a.parentID]){var b=G[a.parentID],c=n(a,"reply");N?(P[a.parentID]&&w.apply(b),s(a.ID,c,b.$el)):(t(a.ID,c,b.$el,a.parentID),x(b))}}function B(a){var b=C(a.userLink);return siteData.blocked_users&&siteData.blocked_users.indexOf(b)>-1}function C(a){return a?a.match(/^\/members\/(\d+)$/)[1]:""}function D(a){a.commentContent&&(G[a.ID]?q(a):B(a)||(j(),a.parentID?A(a):v(a)))}function E(a,b){a.find(".js-date").text(b)}var F,G={},H={},I=$(".js-discussion-side-panel").exists(),J=this.find(".js-scrollto-comment, .js-comments-counter-inside").find(".js-counter"),K=a.find(".js-comments-wrapper"),L=a.find("input.js-stream-comments"),M=Number(J.first().text()),N=I||L.length&&"0"!==d(L.attr("name")),O=[],P={},Q=h("show-more-comments").get(!0),R=Q.find(".js-amount");K.find(".js-comment").each(function(){i(this)}),b.on("comments",D),L.on("change",function(){N=this.checked,e(this.name,N?1:0),N?(y(),z(),Q.detach()):K.prepend(f(!1))}).trigger("change"),Q.on("click",y),c.Comments={addCommentHtml:function(a,b){var c=$(a),d=c.attr("data-comment-id"),e=G[d],f=!!e;if(f?(e.$el.remove(),e=null):c.addClass("displayNone"),i(c),b){var g=G[b];P[b]&&w.apply(g),g.$el.append(c)}else u(d),K.prepend(c);f||(j(),c.fadeIn()),bindReplyAction(c),bindLikeDislikeAction(c),window.blockButtonClickHandlerOuter(c)},addCommentFromJSON:function(a){var b=getDataForCommentTemplate(a),d=h(a.comment_parent_ID?"reply":"comment").reset(b).get(!0);C(b.userLink).is(window.uid)&&d.find(".js-block-option").remove(),i(d,b.commentID),truncateIfNeeded(d.find(".js-text")),E(d,b.dateFormat),a.comment_parent_ID?G[a.comment_parent_ID].$el.append(d):$(".js-comment.comment").last().after(d),m(d,b),window.bindAllCommentSaveActions(d.find(".js-save-item-btn")),window.bindLikeDislikeAction(d.find(".js-like-dislike-box")),window.bindReplyAction(d),a.replies&&a.replies.comments&&a.replies.comments.forEach(function(a){c.Comments.addCommentFromJSON(a)})}}});
// File: comments.js
function shareTheCommentRun(a,b){ajaxData={location:document.location.toString(),access_token:a,comment_text:b},$.ajax({url:"/comments/Service/postOnStocktwits",type:"post",data:ajaxData,success:$.noop})}function openCommentFlagsPopup(a){var b=$("#commentFlagPopup"),c=$("#commentFlag_"+a);c.length&&c.find("span").aint(".flaggedCompleted")?(c.addClass("visible").append(b),b.hasClass("displayNone")&&(b.removeClass("displayNone"),$("#commentFlagSuccessPopup").addClass("displayNone")),b.attr("data-comment-id",a)):(b.addClass("displayNone"),$("#commentFlagSuccessPopup").addClass("displayNone"))}function setErrorMsg(a,b){$("#dialog-attach-chart_"+a+" #dialog-attach-chart-content").append(b),$("#amsg_"+a).append("Get Flash")}function isNewChart(a){return!$("#commentBox_"+a+"_imgDiv img").attr("src")||($("#replaceChart_"+a+"_confirm").prev().removeClass("genToolTip"),$("#replaceChart_"+a+"_confirm").removeClass("displayNone").show(),!1)}function addTooltipClass(a){$(a).removeClass("genToolTip").addClass("genToolTip")}function openChartPopup(a,b,c){var d=$(".js-comments-add-chart-loader"),e=$("#dialog-attach-chart_"+b+" .content #dialog-attach-chart-content");showPopup("dialog-attach-chart_"+b,!0),$("#replaceChart_"+a+"_confirm").addClass("displayNone").hide(),addTooltipClass($("#replaceChart_"+a+"_confirm").prev()),$("#attachTo"+b).val(a);var f=$("#attchChartBtn_"+b);if(flashImageDivId=a,""==$("#dialog-attach-chart_"+b+" #dialog-attach-chart-content").html()){var g;document.old_write=document.write,document.write=function(a){g=$(a)},(chart=createAdvinionHtml5Chart(626,460,b,c))?(d._show(),f.show(),e.html(chart).find("iframe").on("load",function(){window.isFreeToAttachChart=!0,d._hide()})):($("#searchText_"+a).attr("disabled","disabled"),f.hide()),document.write=document.old_write}$("#dialog-attach-chart_"+b).center(),$(window).trigger("commentChartOpened")}function OnShareScreenshot(a,b){$(window).trigger("attachSnapshotImage",[function(c){c=c.substr(22),$("#commentBox_"+b+"_imgDiv").css("display","block"),Share_Callback(c),$("#commentButton_"+b).fadeOut(),hidePopup("dialog-attach-chart_"+a)}])}function MakeSure(a){return window[_0x41bb[1]](a[_0x41bb[0]](22,47))}function Share_Callback(a){var b=flashImageDivId,c=MakeSure(a);$("#attach_"+b).addClass("selected"),$.post("/comments/Service/uploadCommentChart",{img:a,md5:c}).done(function(a){if("ERROR"!=a){var c=commentImagesPath+a;$("#commentBox_"+b+"_img").attr("src",c),$("#commentBox_"+b+"_img").attr("imgName",a),$("#commentBox_"+b+"_imgDiv").removeClass("chartPreview").addClass("chartImg"),$("#dialog-attach-chart_"+b).css({display:"none"}),$("#commentButton_"+b).fadeIn()}})}function openDeletePopup(a){$("#deleteChart_"+a+"_confirm").removeClass("displayNone")}function deleteChart(a){$.post("/comments/Service/deleteCommentChart",{img:$("#commentBox_"+a+"_img").attr("imgName")}),$("#deleteChart_"+a+"_confirm").addClass("displayNone"),$("#commentBox_"+a+"_imgDiv .deleteChartOverlay").attr("style",""),$("#deleteChart_"+a).attr("style",""),reStateImg(a)}function cancelChart(a){$("#deleteChart_"+a+"_confirm").addClass("displayNone")}function cancelReplaceChart(a){$("#replaceChart_"+a+"_confirm").addClass("displayNone"),addTooltipClass($("#replaceChart_"+a+"_confirm").prev())}function reStateImg(a){$("#commentBox_"+a+"_img").attr("src",""),$("#commentBox_"+a+"_imgDiv").removeClass("chartImg").addClass("chartPreview"),$("#commentBox_"+a+"_imgDiv").css("display","none"),$("#attach_"+a).removeClass("selected")}function showHideBigImage(a){bigImgDivId="#commentBigChart"+a,smallImgDivId="#commentSmallChart"+a,$(bigImgDivId).hasClass("displayNone")?($(smallImgDivId).addClass("displayNone"),$("#commentText-"+a).removeClass("withImage"),$(bigImgDivId).removeClass("displayNone"),$(bigImgDivId).fadeTo("normal",1)):$(bigImgDivId).fadeOut("normal",function(){$(bigImgDivId).addClass("displayNone"),$("#commentText-"+a).addClass("withImage"),$(smallImgDivId).removeClass("displayNone")})}function attachChart(a,b){var c,d,e;window.isFreeToAttachChart&&(c=$("#attachTo"+a).val(),d=$("#chart_title_"+a).data("pair_id"),e=$("#commentBox_"+c+"_imgDiv img"),e.attr("src")&&deleteChart(c),OnShareScreenshot(a,c),"undefined"==typeof pairId&&(d=b),disablePostButtonAfterChartAttach(a),e.on("load",function(){enablePostButtonAfterChartAttach(a)}),$("#commentBox_"+c).data("chart_pairid",d))}function setFocusOnPostButton(a){$("#commentBox_"+a)._plainTextExcludedOurElems()&&$("#commentBox_"+a)._plainTextExcludedOurElems().length<=1e3&&$("#commentBox_"+a)._plainTextExcludedOurElems()!==$("#commentBox_"+a).data("default-value")?enablePostButtonAfterChartAttach(a):disablePostButtonAfterChartAttach(a)}function disablePostButtonAfterChartAttach(a){$("#post_"+a).removeClass("orange").addClass("disabledWhite"),$("#attach_"+a).removeClass("selected")}function enablePostButtonAfterChartAttach(a){$("#post_"+a).removeClass("disabledWhite").addClass("orange"),$("#attach_"+a).addClass("selected")}function getLangId(){switch(window.domainId){case 30:return 12;case 31:return 14;case 32:return 15;case 36:return 16;case 37:return 17;default:return window.domainId}}function createAdvinionHtml5Chart(a,b,c,d){return'<iframe id="advinionCommentChart" src="//'+location.host+"/charts/advinion.php?"+d+'" width="'+a+'" height="'+b+'"></iframe>'}function strip(a){var b=document.createElement("DIV");return b.innerHTML=a,b.textContent||b.innerText}function truncateIfNeeded(a){var b,c=a._plainText(),d=$("<span />").text(window.truncatedCommentShowMoreDefine).addClass("showMoreText ");c.length>256&&(b=c.substring(0,256)+"...",d.click(function(){a.html(c)}),a.html(b).append(d))}function calculateLimit(a,b,c){var d=$(a+b)._plainTextExcludedOurElems().length,e=parseInt(c)-parseInt(d);$(a+b+"_feedback").html(e),e<0?($(a+b+"_feedback").addClass("redFont"),$("#post_"+b).removeClass("orange").addClass("disabledWhite"),$("#attach_"+b).removeClass("selected")):($(a+b+"_feedback").removeClass("redFont"),$("#commentBox_"+b)._plainText()?($("#post_"+b).removeClass("disabledWhite").addClass("orange"),$("#attach_"+b).addClass("selected")):($("#post_"+b).removeClass("orange").addClass("disabledWhite"),$("#attach_"+b).removeClass("selected")),e>100?$(a+b+"_feedback").addClass("displayNone"):$(a+b+"_feedback").removeClass("displayNone"))}function close_comment_notification(a){$(a.parentElement).fadeOut("fast")}function avoidEmptyCommentSubmitError(a){$("#post_"+a).on("click",function(b){var c=$("#commentBox_"+a);(""==c._plainText()||c._plainText()>1e3)&&(hideOverlay(),$(".guidelinesBoxWrapper, .guidelinesBoxWrapperAbove").css("margin-left",""))})}function updateCommentsDates(a){$("div[data-comment-id] .commentBody").each(function(){var b,c,d=$(this),e=parseDateUTC($("span[comment-date]",d).attr("comment-date"));e&&(b=$("span[comment-date]",d).attr("comment-date-formatted"),(c=a.FormatDateTime(e,b))&&$("span[comment-date]",d).html(c.toString()))})}function parseDateUTC(a){var b=/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/,c=b.exec(a);return c?new Date(Date.UTC(c[1],c[2]-1,c[3],c[4],c[5],c[6])):null}function processCommentsRetrieve(a,b){var c=$(b);return c.children(":first")&&c.children(":first").children(":last-child").remove(),a.callback=function(a){setTimeout(function(){var b=$("<div />").html(a).hide().appendTo(".js-comments-wrapper");b.fadeIn(),c.remove(),window.bindAllCommentSideActions(),window.bindAllCommentSaveActions(b.find(".js-save-item-btn")),b.find(".js-comment").each(function(){bindReplyAction($(this))})},1e3)},a}function processRepliesRetrieve(a,b){var c=$(b),d=$("#autoRefreshEnabled");return a.parent=c.parents("[data-comment-id]:first").data("comment-id"),a.callback=function(b){setTimeout(function(){var e=$('<div class="displayNone">'+b+"</div>");c.before(e),c.children(":last-child").remove(),c.prev().fadeIn(),c.remove(),d.length&&d.trigger("autoRefresh-NewComment",[b,a.parent]),e.find(".js-comment").each(function(){bindReplyAction($(this))}),window.bindAllCommentSideActions(),window.bindAllCommentSaveActions(e.find(".js-save-item-btn")),c.find(".showMoreReplies.loading").removeClass("loading"),e.find(".js-like-dislike-box").each(function(){window.bindLikeDislikeAction($(this))})},1e3)},a}function onPaste(){var a=$(this),b=a.caret(),c=a.text().length;setTimeout(function(){var d=null,e=a.find("span.replyTo").first();e.size()&&(d=e.clone(),e.remove()),a.html(a._plainTextWBR()),d&&a.prepend("&nbsp;").prepend(d),a.caret(b+(a.text().length-c))},100)}function assignCommentEvents(a,b,c){function d(){var a=$(".js-main-comment"),b=a.find(".js-comment-box-inner"),c=a.find(".commentBoxWrap");a.find(".js-attach-chart").hover(function(a){b.toggleClass("showBorder",!c.hasClass("expanded")&&a.type.is("mouseenter"))})}function e(){$(".js-comment-box").each(function(){var a=$(this);a.is(":visible")&&!a._plainTextExcludedOurElems().trim()&&(a.closest(".js-comment.comment").removeClass("replying"),a.closest(".js-comment").data("reply-box-visible",0).find(".js-reply-box-wrapper").remove())})}function f(a,b){var d,f,g,h=$("#replyBoxTemplate").html(),i=($(this).parent(),$(this).data("$comment"));if(e(),i.addClass("replying"),!i.data("reply-box-visible")){var j;i.data("reply-box-visible",1),i.hasClass("js-comment-reply")?(g=i.parents(".js-comment").eq(0).data("comment-id"),j=g+"_"+$(this).data("real-parent-id")):(g=i.data("comment-id"),j=g),h=h.replace(/ADD_ID_HERE/g,j),d=$('<div class="displayNone replyTemplate js-reply-box-wrapper">'+h+"</div>"),d.find(".js-guidelines").remove(),i.append(d.click($.stopProp)),d.fadeIn(),f=d.find('div[contentEditable][id^="commentBox_"]'),f.attr("contentEditable",!0),f.css({height:100});var k=f.attr("data-real_parent_id");f.focus(function(){setFocusOnPostButton(k)}).blur(function(){setFocusOnPostButton(k)}).on("keyup",function(a){setFocusOnPostButton(k),calculateLimit("#commentBox_",k,1e3)}).on("paste",onPaste),f.data("default-value",f.text()).html("").blur(function(){var a=this,b=/^\\+$/.test($.trim($(this)._plainText()));setTimeout(function(){(b||""==$.trim($(a)._plainText())&&!$(a).is(":focus"))&&$(a).html($(a).data("default-value"))},300)}).click(function(){c.validate($(this)._plainText())||$(this).html("")}).attr("data-comment-parent-id",g),c.enablePostBtn($("#post_"+j))}var l=i.children(".js-reply-box-wrapper").find('div[contentEditable][id^="commentBox_"]');return b||window.uid==$(a).data("to-user-id")?l.html("").focus():l.attr({"data-to-user-name":$(a).data("to-user-name"),"data-to-user-id":$(a).data("to-user-id")}).html($("<div>").html($("<span>").addClass("replyTo").prop("contentEditable",!1).html($(a).data("to-user-name"))).append("&nbsp;")).caret(-1),$("body").animate({scrollTop:l.offset().top-300+"px"},500,function(){}),!1}function g(a){var b=a.parents(".js-comment");b.length?a.find(".js-reply-btn").data("$comment",a).on("click",function(a){f.call(b.find(".js-content .js-reply-btn"),this,!1),a.stopPropagation()}):a.find(".js-content .js-reply-btn").data("$comment",a).on("click",function(a){f.call(this,this,!0),a.stopPropagation()}),$(function(){window.blockButtonClickHandlerOuter(a)})}$("#commentBox_"+b+"_wrapper").click(function(){$("#commentBox_"+b).focus()}),$("#commentBox_"+b).each(function(){$(this).data("default-value",$(this)._plainTextWBR())}).focus(function(){$(this)._plainTextWBR()==$(this).data("default-value")&&$(this).html(""),setFocusOnPostButton(b)}).blur(function(){var a=/^\\+$/.test($.trim($(this)._plainText()));(""==$.trim($(this)._plainTextWBR())||a)&&$(this).html($(this).data("default-value")),setFocusOnPostButton(b)}).on("keydown",function(a){var b=$(this)._plainTextExcludedOurElems().split("\n").length;13==a.keyCode&&b<12&&$(this).attr("rows",b+1)}).on("keyup",function(a){setFocusOnPostButton(b),calculateLimit("#commentBox_",b,1e3)}).on("paste",onPaste),c.enablePostBtn($("#post_"+b)),$(".js-comment").each(function(){g($(this))}),d(),$('a[data-action="listComments"], a[data-action="listReplies"]['+b+"]").live("click",function(){var a=$(this).addClass("loading").data("action"),d={action:a},e=$("#commentBox_"+b);switch(d.section=e.data("comment-section-id"),d.content=e.data("comment-content-id"),d.author=e.data("comment-author-id"),a){case"listReplies":d=processRepliesRetrieve(d,this);break;case"listComments":d=processCommentsRetrieve(d,this)}return c.list(d),!1}),window.bindReplyAction=g;var h=$("#comment-guidelines-container"+b);$(".js-comment-guidelines-anchor").click(function(){h=$("#comment-guidelines-container"+b),h.is(":visible")||(h.show().center(),bindEscape("#comment-guidelines-container"+b,".closePopup"),$("#agreementBox_"+b).addClass("displayNone"),showOverlay())}),$(a).mouseup(function(a){h.is(":visible")&&(($(a.target).parents().is("#comment-guidelines-container"+b)||$(a.target).is("#comment-guidelines-anchor"+b)||$(a.target).is(".generalOverlay")||$(a.target).is(".hoverboxWithShadow"))&&!$(a.target).is("#comment-guidelines-close")||($("#agreementBox_"+b).addClass("displayNone"),$("#comment-guidelines-container"+b).removeClass("firstPending").hide(),hideOverlay(),$(".guidelinesBoxWrapper, .guidelinesBoxWrapperAbove").css("margin-left","")))}),$(".closePopup").on("click",function(){$(this).parent().hasClass("firstPending")&&hideOverlay(),$.ajax({url:"/comments/Service/clearSession",type:"get",data:{action:"clearSession",content:b},success:function(a){}})}),$(a).on("click",e),$(function(){$(".js-comment-attach-chart-popup").on("click",$.stopProp)})}$.fn._plainText=function(){return(this[0].innerText||this[0].textContent).trim()},$.fn._plainTextWBR=function(){return this._plainText().split("\n").join("<br>")},$.fn._plainTextExcludedOurElems=function(){var a=this.clone();return a.find(".replyTo").remove(),a._plainText()},$(document).ready(function(){function a(a){$("#commentFlagPopup:visible, #commentFlagSuccessPopup:visible").length&&$(a.target).aint(".js-thinDropdownArrow, .opened")&&$(window).trigger("tooltipClosed")}$("body").click(function(b){$(b.target).aint(".commentFlagIcon, .js-thinDropdownArrow")&&a(b),$("#commentFlagPopup").addClass("displayNone").attr("data-comment-id","").parent().removeClass("visible"),$("#commentFlagSuccessPopup").addClass("displayNone").attr("data-comment-id",""),$("input","#commentFlagPopup").prop("checked",!1),$("#commentFlagPopupSubmit").addClass("disabled")}),$("#commentFlagPopup").on("click",function(a){a.stopPropagation()}),$("#commentFlagSuccessClose").on("click",function(a){$("#commentFlagSuccessPopup").addClass("displayNone")}),$("#commentFlagPopup INPUT").change(function(){$("#commentFlagPopupSubmit").removeClass("disabled")}),$(window).on("removeFlagPopupFromComment",function(){$(".js-commentary").append($("#commentFlagPopup"))}),$("#commentFlagPopupSubmit").on("click",function(a){var b=$("#commentFlagPopup");if(!$(this).hasClass("disabled")&&$(this).isChildOf(".js-commentary")){var c=$('input[name="commentFlagType"]:checked',b).val(),d=b.attr("data-comment-id"),e={action:"flagComment",commentID:d,flagType:c};if(!window.siteData.userLoggedIn)return overlay.authCompleteAction={type:"flagComment",actionData:e},void overlay.overlayLogin();b.addClass("displayNone"),$('[name="commentFlagType"]',b).prop("checked",!1),$("#commentFlagPopupSubmit").addClass("disabled"),b.attr("data-comment-id",""),$.ajax({url:"/comments/Service/flagComment",type:"post",data:e,success:function(a){if("unauthorized"==a)overlay.overlayLogin();else{$("#commentFlagSuccessPopup").removeClass("displayNone");var b=$("#commentFlag_"+d);b.addClass("flagged").append($("#commentFlagSuccessPopup")),b.attr("data-tooltip",b.attr("data-alternate")),b.find("span").addClass("flaggedCompleted")}}})}}),$('[id^="commentFlag_"]').live("click",function(a){var b=$(this).attr("id");b=b.replace("commentFlag_",""),openCommentFlagsPopup(b)}),window.socialComments={global:new SocialComments($("#addAComment"),window.socialCommentsApplicationsIds||{})},$(".js-comment").find(".js-text").each(function(){truncateIfNeeded($(this))})}),window.isFreeToAttachChart=!1;var _0x41bb=["substr","btoa"];$(function(){var a=$(".js-comment-popup-chart-img");window.openViewChartPopup=function(b){var c=$("#commentBigChart"+b);a.attr("src",c.find("img").attr("src")),showPopup("commentChartImgPopup",!0)}}),$("#scrollToComments").live("click",function(){$.scrollTo($("#addAComment"),1e3),scroll_up_comments()});var elapsedTimeFormat=function(a,b){function c(a,b,c){var d,e,f,g;for(var h in b)if(b.hasOwnProperty(h)){var i=b[h];for(var j in i)if(i.hasOwnProperty(j))if(d=i[j].toString(),e=d.split("-"),e.length>1){if(f=e[0],g=e[1],parseInt(a)>=f&&parseInt(a)<=g)return-1!=h.indexOf("X")?h.replace("X",a):h}else if(parseInt(a)==parseInt(d))return-1!=h.indexOf("X")?h.replace("X",a):h}}function d(a,d){var f,g,h=new Date,i=0,j=0;return a&&a.constructor===Date?(f=Math.floor((h.getTime()-a.getTime())/1e3),f>=86400?g=d:f<60?g=b:f<3600?(i=Math.floor(f/60),g=c(i,e.minutes,a)):f<86400&&(j=Math.floor(f/3600),g=c(j,e.hours,a))):g="",g}var e=JSON.parse(a);this.FormatDateTime=d},FPcomments=function(a,b,c,d){function e(a){$.ajax({url:"/comments/Service/flag",type:"get",data:{action:"flag",comment:a},success:function(a){},error:function(){setTimeout(function(){e(a)},5e3)}})}function f(a){$.ajax({url:"/comments/Service/list",type:a.method,data:a.data,success:a.callback,error:function(){setTimeout(function(){sendListService(a)},5e3)}})}function g(a){f({data:{action:a.action,parent:a.parent,section:a.section,content:a.content,author:a.author,isDiscussionPanel:!!r},callback:a.callback,method:"get"})}function h(a){q||(q=!0,a.hide()._show(),a.slideDown(500),setTimeout(function(){a.slideUp(500),q=!1},5e3))}function i(a,e){var f=$(a),g=f._plainText(),q=f.data("real_parent_id"),r=f.data("comment-content-id"),t=$("#commentBox_"+q+"_img").attr("src"),u=f.data("comment-section-id"),v=f.data("content-title"),w=f.data("content-url"),x=f.data("comment-parent-id"),y=$("[data-comment-id="+x+"]"),z=(x?f.closest(".js-reply-box-wrapper"):f.closest(".addAComment")).find("#note_container"),A=$("#viewComments_"+r+" .commentsWrapper"),B=($(".showMoreReplies",y),$("#post_"+q)),C=f.data("chart_pairid"),D=(f.closest(".js-comment").data("user-id"),new $.idKeeper(window.getFollowedPostsIdsFromStorage())),E=$("#autoRefreshEnabled"),F=E.length>0;if(p&&(new Date).getTime()-p<6e4)return void h(z);if(p=null,k(g)){void 0!=t&&""!=t&&(t=t.replace(c,""));var G={action:"add",isFirstComment:b?1:0,isAgree:!1,sectionID:u,contentID:r,commentParentID:x,replyToID:f.data("to-user-id"),replyToName:f.data("to-user-name"),commentText:g,contentTitle:v,imageName:t,contentURL:w,chartPairId:C,socialComments:x?null:socialComments.global.getSelected(),discussionPanel:+!!e},H=(G.parent?"Reply A Comment":"Add A Comment")+" - "+(siteData.userLoggedIn?"Logged In":"Not Logged In");if(socialComments.global.vkIsOn()&&(G.vk=!0),window.ga&&window.ga("allSitesTracker.send",{hitType:"event",eventCategory:"Social Buttons",eventAction:"Comments",eventLabel:H}),F&&(G.autoRefresh="enabled"),!window.siteData.userLoggedIn)return overlay.authCompleteAction={type:"comment",actionData:G},void overlay.overlayLogin();l(B),n(B),$.ajax({url:"/comments/Service/add",type:"get",dataType:"json",data:G,success:function(c){if(z._hide(),"unauthorized"==c.result)overlay.authCompleteAction={type:"comment",actionData:c.comment_data},overlay.overlayLogin();else if("failed"==c.result)p||(p=(new Date).getTime()),h(z);else if("userBanned"==c.result)$(x?"#userBannedReply":"#userBanned")._show();else if("replyingToBlocked"==c.result)$("#userBannedReply")._show().find(".alertText").text(replyToBlockedUserDefine);else if("agreementbox"==c.result)$("#comment-guidelines-container"+r).addClass("firstPending").show().center().css({left:"",bottom:"auto"}),bindEscape("#comment-guidelines-container"+r,".closePopup"),$("#agreementBox_"+r).removeClass("displayNone"),$("#guidelinesCheckbox"+r).removeAttr("checked"),$("#guidelinesButton"+r).addClass("disabled"),showOverlay(),$("#guidelinesButton"+r).unbind("click").bind("click",function(){"checked"==$("#guidelinesCheckbox"+r).attr("checked")&&(l(B),n(B),$("#agreementBox_"+r).addClass("displayNone"),$("#comment-guidelines-container"+r).removeClass("firstPending").hide(),hideOverlay(),G.isAgree=!0,$.ajax({url:"/comments/Service/add",type:"get",dataType:"json",data:G,success:function(c){"failed"==c.result||("pendingmessage"==c.result?$("#pendingMessage"+r).removeClass("displayNone").show():(void 0===x?(components.Comments.addCommentHtml(c.result,null),reStateImg(r),b&&$("#viewComments_"+r).prepend("<h3>"+d+"</h3>")):(components.Comments.addCommentHtml(c.result,x),f.parents(".js-comment").eq(0).data("reply-box-visible",0),f.parents(".js-reply-box-wrapper").eq(0).remove()),socialComments.global.sendClientPosts(g,c.comment_ID,c.shortLink),socialComments.global.resetAll()),$("#commentBox_"+q+"_img").attr("src",""),$("#commentBox_"+q+"_imgDiv").css({display:"none"}),$(a).html($(a).data("default-value")),$("#commentBox_"+r+"_feedback").html(1e3).addClass("displayNone")),m(B),o(B)},error:function(){setTimeout(function(){i()},5e3)}}))});else{if("pendingmessage"==c.result)$(".commentNotification").addClass("displayNone").hide(),$("#pendingMessage"+r).removeClass("displayNone").show();else if($(".commentNotification").addClass("displayNone").hide(),void 0===x)socialComments.global.sendClientPosts(g,c.comment_ID,c.shortLink),socialComments.global.resetAll(),components.Comments.addCommentHtml(c.result,null),reStateImg(r),F&&E.trigger("autoRefresh-NewComment",[c.result,"0"]),b&&$("#viewComments_"+r).prepend("<h3>"+d+"</h3>"),b=!1,$("#agreementBox_"+r).addClass("displayNone");else{if(components.Comments.addCommentHtml(c.result,x),F){var e=y.find(".js-AutoRefreshItem");e.length||E.trigger("autoRefresh-NewComment",[c.result,x])}f.parents(".js-comment").eq(0).data("reply-box-visible",0),f.parents(".js-reply-box-wrapper").eq(0).remove()}$("#publish_on_stocktwits").is(":checked")&&j($(a)._plainText(),document.location),$("#commentBox_"+q+"_img").attr("src",""),$("#commentBox_"+q+"_imgDiv").css({display:"none"}),$(a).html($(a).data("default-value")),$("#commentBox_"+r+"_feedback").html(1e3).addClass("displayNone")}m(B),o(B),$(".js-expanded .commentBoxWrap").removeClass("expanded"),s.removeClass("addACommentExpanded"),D.store(""+(x||c.comment_ID),!0),window.saveFollowedPostsIdsToStorage(D.get()),window.bindAllCommentSideActions(),window.bindAllCommentSaveActions(A.find(".js-commentDropDownWrapper:not([eventbound]) .js-save-item-btn"))},error:function(){setTimeout(function(){i()},5e3)}})}else $(".commentBox_"+r).addClass("error"),hideOverlay(),$(".guidelinesBoxWrapper, .guidelinesBoxWrapperAbove").css("margin-left",""),console.log("Error occured!")}function j(a,b){if(stocktwits_access_token=localStorage.getItem("stocktwits_access_token"))shareTheCommentRun(stocktwits_access_token,a);else{var c=function(b){(stocktwits_access_token=localStorage.getItem("stocktwits_access_token"))&&shareTheCommentRun(stocktwits_access_token,a)};addEventListener("message",c,!1);window.open("https://api.stocktwits.com/api/2/oauth/authorize?client_id=a6d2177eead3dd52&scope=publish_messages&redirect_uri=http://mikhail.dev.forexpros.com/stocktwits-oauth.html&response_type=token","stocktwits_oauth","width=500,height=550")}}function k(b){return!/^\\+$/.test(b)&&""!=$.trim(b)&&b!=$("#commentBox_"+a).data("default-value")&&b!=$("#commentBox_"+a).data("replyTextarea_default-value")}function l(a){var b=$("#postBtnLoadingTemplate").html();$(a).before(b)}function m(a){$(a).prev().remove()}function n(a){a.unbind("click").click(function(){return!1})}function o(a){a.click(function(){var b=a.attr("contentId");return $(a).hasClass("disabledWhite")||i($("#commentBox_"+b),a.isChildOf(".js-discussion-side-panel")),!1})}var p,q=!1,r=$(".js-discussion-side-panel").exists(),s=$(".js-discussion-side-panel");this.enablePostBtn=o,this.validate=k,this.flag=e,this.list=g,this.listService=f};window.getDataForCommentTemplate=function(a){return{commentID:a.comment_ID,username:a.comment_user_name,userLink:a.user.member_profile_href,usernameAlt:a.comment_user_name,userImage:a.user_image,dateFormat:a.comment_date,dateFormatted:a.comment_date,dateLabel:a.comment_date,dateTitle:"",commentImage:a.comment_image,commentImageSmall:a.comment_image,commentContent:{value:a.comment_text.replace(/\n/g,"."),unEscape:!0},commentLink:a.title_href,commentAlt:a.comment_image_alt,isMasterUser:0,isCommentByAuthor:a.is_content_author}},$(function(){function a(){new window.LazyLoadingHandler(q),g.on("click",c.bind(null,!0)),$(window).on("commentChartOpened",c.bind(null,!0)),f.click(function(){c(!k)})}function b(){a(),null===m&&$("body").width()>1684||m?c(!0):null===m?(p=!1,k=!1,e.removeClass("closed").addClass("closedAddComment")):p=!1}function c(a){k=a,e.removeClass("closedAddComment").toggleClass("closed",!k),Storage.set("panelVisibilityLastState",k),a&&window.hj&&window.hj("trigger","discussion_side_panel_is_opened"),p||o||($.run(window.ga,"allSitesTracker.send","event","Discussions Side Panel","Minimize/Expand",k?"Expand":"Minimize"),o=!0),p=!1}function d(a){var b=a.comments;window.ga&&window.ga("allSitesTracker.send","event","Discussions Side Panel","Load More Comments","Load Page "+l++),Object.keys(b).reverse().forEach(function(a){window.components.Comments.addCommentFromJSON(b[a])}),window.bindAllCommentSideActions()}var e=$(".js-discussion-side-panel"),f=e.find(".js-close-discussion-button"),g=e.find(".js-comment-box-inner"),h=e.find(".js-comments-wrapper"),g=$(".js-comment-box").first(),i=g.data("comment-section-id"),j=g.data("comment-content-id"),k=!1,l=1,m=Storage.get("panelVisibilityLastState"),n=!0,o=!1,p=!0,q={appendFunction:d,$container:h,scrollParams:{debounceMS:16,getDataOffset:250,appendOffset:1e3},getData:function(a){var b=$(".js-comment.comment").last().data("comment-id");n&&(n=!1,$.ajax({url:"/comments/Service/more",dataType:"json",data:{section:i,content:j,smaller_id:b},success:function(b){a(b),n=!0}}))}};e.exists()&&b()});
// File: like-dislike.js
!function(){function a(a,c,e,f,g){return function(){var h=$(this).is(":checked"),k={item_id:c,item_type:"comment",like:e};j?(h&&a.prop("checked")&&(b(g,-1),a.prop("checked",!1)),b(f,h?1:-1),d(k,h),i=(new Date).getTime(),window.ga("allSitesTracker.send","event","Social Buttons","Comments",(e.is("like")?"Like":"Dislike")+" Comment")):$.isFu(getSelection)&&$.isFu(getSelection().empty)&&getSelection().empty()}}function b(a,b){a.text(Math.max(+a.text()+b,0))}function c(){return siteData.userLoggedIn?"UserReactions":"UserReactionsLoggedOut"}function d(a,b){$.ajax({type:"POST",url:"/services/service/setLike",data:a,success:function(){b?h[a.item_id]=a.like:delete h[a.item_id],Storage.set(c(),h)}})}function e(){var a=(new Date).getTime();j?i?i+1e3>a&&(j=!1,f(this),setTimeout(function(){j=!0},500)):i=a:f(this)}function f(a){$(a).prop("checked",!$(a).is(":checked"))}function g(){var c=$(this),d=c.find("input.js-like-checkbox"),f=c.find("input.js-dislike-checkbox"),g=c.find(".js-like-count"),i=c.find(".js-dislike-count"),j=c.data("itemId");h[j]&&((h[j].is("like")?d:f).prop("checked",!0),(h[j].is("like")?g:i).text().is("0")&&b(h[j].is("like")?g:i,1)),d.on("change",e),f.on("change",e),d.on("change",a(f,j,"like",g,i)),f.on("change",a(d,j,"dislike",i,g))}var h,i,j=!0;$(function(){var a;(a=Storage.get(c(),!0))&&a.is("undefined")&&(a=null,Storage.remove(c()));try{h=a?JSON.parse(a):{}}catch(b){h={}}$(".js-like-dislike-box").each(g)}),window.bindLikeDislikeAction=function(a){g.call(a)}}();
// File: social-comments.js
function SocialComments(a,b){function c(a){g[a]?(g[a]=!1,i[a].removeClass("shareIconSelected")):h[a].check(function(b){g[a]=b,i[a].addClass("shareIconSelected")})}function d(a){window.onSocialAuthorization=e,j=a}function e(a,b){g[a]=b,h[a]&&h[a].serverAuth(b),j.close(),j=null,delete window.onSocialAuthorization}var f={twitter:"Also Post to Twitter",stockTweets:"Also Post to Stock Twits",twitter$stockTweets:"Also Post to All Socials",VK:"Also Post to VKontakte"},g={facebook:!1,twitter:!1,stockTweets:!1,VK:!1},h={VK:new SocialClientPost("//vk.com/js/api/openapi.js",function(a){this.loadSDK(function(){this.verified?a(this.verified):(window.VK.init({apiId:b.VK}),VK.Auth.login(function(b){this.verified=!!b.session,a(this.verified)}.bind(this)))}.bind(this))},function(a,b,c){VK.Api.call("wall.post",{message:a+" "+c},$.noop)}),facebook:new SocialClientPost("//connect.facebook.net/en_US/sdk.js",function(a){this.onServerAuth(function(c){this.authCode=c,window.FB.init({appId:b.facebook,version:"v2.7"}),window.FB.getLoginStatus(function(b){this.verified=b&&"connected"===b.status,a(this.verified)}.bind(this))}.bind(this)),this.loadSDK(function(){this.verified?a(this.verified):$.ajax("/social/Service/getOAuthUrl",{method:"POST",data:{socialType:"facebook"},success:function(a){d(window.open(a,"fb_oauth","width=500,height=550"))}})}.bind(this))},function(a){window.FB.ui({method:"feed",caption:"",link:location.href},$.noop)}),twitter:{post:function(a,b,c){var d={socialType:"twitter",comment:a,comment_ID:b,shortLink:c,token:localStorage.getItem(window.uid+"_twitter_access_token"),secret:localStorage.getItem(window.uid+"_twitter_access_token_secret")};$.post("/social/Service/postCommentToSocials",d,$.noop)}},stockTweets:{post:function(a,b,c){var d={socialType:"stocktwits",comment:a,comment_ID:b,shortLink:c,token:localStorage.getItem("stocktwits_access_token")};$.post("/social/Service/postCommentToSocials",d,$.noop)}}},i={},j=null;i.stockTweets=a.find(".js-stocktwits-auth").on("click",function(){var a=$(this),b=localStorage.getItem("stocktwits_access_token");if(siteData.userLoggedIn)if(a.is(".shareIconSelected")&&b)i.stockTweets.removeClass("shareIconSelected"),g.stockTweets=!1,localStorage.setItem("stocktwits_access_token","");else{var c="f5c1f501b6e22c14",d="https://api.stocktwits.com/api/2/oauth/authorize?client_id="+c+"&scope=publish_messages&redirect_uri="+window.location.protocol+"//"+window.location.hostname+"/social/StockTOAuth&response_type=token",e=window.open(d,"stocktwits_oauth","width=500,height=550");window.stockTweetsCloseHandler=function(){g.stockTweets=!0,a.addClass("shareIconSelected"),e.close()}}else overlay.overlayLogin()}),i.facebook=a.find(".js-facebook-auth").on("click",function(){}),i.twitter=a.find(".js-twitter-auth").on("click",function(){var a={socialType:"twitter"},b=localStorage.getItem(window.uid+"_twitter_access_token"),c=localStorage.getItem(window.uid+"_twitter_access_token_secret"),d=$(this);siteData.userLoggedIn?d.hasClass("shareIconSelected")?(d.removeClass("shareIconSelected"),g.twitter=!1):("string"==typeof b&&b.length>0&&(a.access_token=b),"string"==typeof c&&c.length>0&&(a.access_token_secret=c),$.ajax("/social/Service/getOAuthUrl",{method:"POST",data:a,success:function(a){if(1==a)return g.twitter=!0,d.addClass("shareIconSelected"),!0;var b=window.open(a,"tw_oauth","width=500,height=550");window.tweeterCloseHandler=function(){g.twitter=!0,d.addClass("shareIconSelected"),b.close()}}})):overlay.overlayLogin()}),i.VK=a.find(".js-vkontakt-auth").on("click",function(){siteData.userLoggedIn?c("VK"):overlay.overlayLogin()}),this.vkIsOn=function(){return g.VK},this.getSelected=function(){return g},this.sendClientPosts=function(a,b,c){var d,e=[];for(var i in g)g[i]&&h[i]&&(h[i].post(a,b,c),e.push(i));(d=f[e.join("$")])&&ga("allSitesTracker.send","event","Social Buttons","Add A Comment",d)},this.resetAll=function(){g.stockTweets&&localStorage.setItem("stocktwits_access_token","");for(var a in g)g[a]=!1,i[a].removeClass("shareIconSelected")}}function SocialClientPost(a,b,c){function d(b){if(e)b();else{var c=document.createElement("script");c.src=a,c.async=!1,c.onload=b,c.type="text/javascript";var d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(c,d),e=!0}}var e=!1,f=$.noop;this.verified=!1,this.loadSDK=d,this.check=b,this.post=c,this.serverAuth=function(a){f(a)},this.onServerAuth=function(a){f=a}}