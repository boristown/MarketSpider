// File: patterns.js
var Patterns={patternsData:{},texts:{},tableView:!1,getPatternImage:function(a){return"Bullish"==a.sqlData.pattern_type&&"reversal"==a.sqlData.indication?"bullRevIcon":"Bearish"==a.sqlData.pattern_type&&"reversal"==a.sqlData.indication?"bearRevIcon":"Bullish"==a.sqlData.pattern_type&&"reversal"!=a.sqlData.indication?"bullContIcon":"Bearish"==a.sqlData.pattern_type&&"reversal"!=a.sqlData.indication?"bearContIcon":void 0},getPatternTooltip:function(a){var b=this;return"Bullish"==a.sqlData.pattern_type&&"reversal"==a.sqlData.indication?b.texts._candlestick_patterns_bullish_reversal:"Bearish"==a.sqlData.pattern_type&&"reversal"==a.sqlData.indication?b.texts._candlestick_patterns_bearish_reversal:"Bullish"==a.sqlData.pattern_type&&"reversal"!=a.sqlData.indication?b.texts._candlestick_patterns_bullish_continuation:"Bearish"==a.sqlData.pattern_type&&"reversal"!=a.sqlData.indication?b.texts._candlestick_patterns_bearish_continuation:void 0},getReliabilityImg:function(a){var b=[{k:"low",structure:'<i class="reliabilityStarLightIcon"></i><i class="reliabilityStarLightIcon"></i>'},{k:"medium",structure:'<i class="reliabilityStarDarkIcon"></i><i class="reliabilityStarLightIcon"></i>'},{k:"moderate",structure:'<i class="reliabilityStarDarkIcon"></i><i class="reliabilityStarLightIcon"></i>'},{k:"high",structure:'<i class="reliabilityStarDarkIcon"></i><i class="reliabilityStarDarkIcon"></i>'}],c="";return $(b).each(function(b,d){d.k==a&&(c=d.structure)}),c},getReliabilityTooltip:function(a){var b=this,c=[{k:"low",structure:b.texts._candlestick_patterns_Low},{k:"medium",structure:b.texts._candlestick_patterns_medium},{k:"moderate",structure:b.texts._candlestick_patterns_medium},{k:"high",structure:b.texts._candlestick_patterns_High}],d="";return $(c).each(function(b,c){c.k==a&&(d=c.structure)}),d},formatEmergingTimeframe:function(a){var b=a.split("_");return b[2]},convertTimeframe:function(a){var b=a.toString();switch(b){case"60":return"1";case"300":return"5";case"900":return"15";case"1800":return"30";case"3600":return"1H";case"18000":return"5H";case"86400":return"1D";case"604800":return"1W";case"week":return"1W";case"month":return"1M"}},openDesc:function(a,b){var c,d=this,e=Patterns.patternsData,f=b?e["portfolio"+b][a].desc:e[a].desc,g=b?"_"+b+"_":"",h="#rowDesc"+g+a,i=$(h),j=$("#row"+g+a).find("td").length;i.length?i.remove():(c='<tr class="rowDesc noHover" id="rowDesc'+g+a+'"><td class="left" colspan="'+j+'">',c+='<img src="'+f.img+'">',Patterns.tableView&&"completed"===f.category&&(c+='<div class="detailRow"><label>'+d.texts._candlestick_patterns_candle_time+"</label>",c+="<span>",c+=(f.time||"")+' <i class="candlesAgo">'+f.candle+" "+d.texts._candlestick_patterns_candles_ago+"</i>",c+="</span>",c+="</div>"),c+='<div class="detailRow"><label>'+d.texts._candlestick_patterns_indication+"</label><span>"+f.type+"</span></div>",c+='<div class="detailRow"><label>'+d.texts._candlestick_patterns_reliability+"</label><span>"+f.reliability+"</span></div>",c+='<div class="detailRow"><label>'+d.texts._candlestick_patterns_description+"</label><span>"+f.desc+"</span></div>",c+="</td></tr>",$("#row"+g+a).after(c))},loadPatterns:function(){var a=this,b=Patterns.texts,c="";c+="<tr>",c+='<td colspan="6" style="text-align: center;">'+b._candlestick_patterns_loading_msg+"</td>",c+="</tr>",$("#patternTableBody").html(c),$("#candleStick_filters").slideUp("slow"),$.ajax({method:"POST",url:"/instruments/Service/cspFilter",data:"pairID="+$(".js-instrument-id-input").val()+"&"+$("#candleStick_filters *").serialize()}).done(function(b){$("#patternTableBody").html(""),0==b.emerging.length&&0==b.completed.length&&(c='<tr class="noHover">',c+='<td colspan="6" class="center">'+a.texts._Candlestick_No_Patterns_Recognized+"</td>",c+="</tr>",$("#patternTableBody").append(c));var d=0;0!=b.emerging.length&&(c='<tr class="noHover">',c+='<td colspan="6" class="theDay">'+a.texts._candlestick_patterns_emerging_patterns+"</td>",c+="</tr>",$("#patternTableBody").append(c),$(b.emerging).each(function(b,e){Patterns.patternsData[d]=e,c='<tr id="row'+d+'" onClick="Patterns.openDesc('+d+');">',c+='<td class="icon" title="'+Patterns.getPatternTooltip(e)+'"><span class="'+Patterns.getPatternImage(e)+'"></span></td>',c+='<td class="left bold">'+e.desc.name+"</td>",c+='<td class="left">'+Patterns.convertTimeframe(Patterns.formatEmergingTimeframe(e.k))+"</td>",c+='<td class="left" title="'+Patterns.getReliabilityTooltip(e.sqlData.reliability)+'"><i class="reliabilityStarDarkIcon"></i>'+Patterns.getReliabilityImg(e.sqlData.reliability)+"</td>",c+='<td class="left" colspan="2">'+a.texts._candlestick_patterns_current+"</td>",c+="</tr>",$("#patternTableBody").append(c),d++})),0!=b.completed.length&&(c='<tr class="noHover">',c+='<td colspan="6" class="theDay">'+a.texts._candlestick_patterns_completed_patterns+"</td>",c+="</tr>",$("#patternTableBody").append(c),$(b.completed).each(function(a,b){Patterns.patternsData[d]=b,c='<tr id="row'+d+'" onClick="Patterns.openDesc('+d+');">',c+='<td class="icon" title="'+Patterns.getPatternTooltip(b)+'"><span class="'+Patterns.getPatternImage(b)+'"></span></td>',c+='<td class="left bold">'+b.desc.name+"</td>",c+='<td class="left">'+Patterns.convertTimeframe(b.timeframe)+"</td>",c+='<td class="left" title="'+Patterns.getReliabilityTooltip(b.sqlData.reliability)+'"><i class="reliabilityStarDarkIcon"></i>'+Patterns.getReliabilityImg(b.sqlData.reliability)+"</td>",c+='<td class="left">'+b.candle+"</td>",c+='<td class="noWrap">'+b.dateTime+"</td>",c+="</tr>",$("#patternTableBody").append(c),d++}))})},restoreFilterDefaults:function(){$("select#time_frame").prop("selectedIndex",0),$("select#pattern_direction").prop("selectedIndex",0),$("select#indication").prop("selectedIndex",0),$("select#reliability").prop("selectedIndex",0)},bindFilters:function(a){function b(){p={emerging:Patterns.texts._candlestick_patterns_emerging_patterns,completed:Patterns.texts._candlestick_patterns_completed_patterns}}function c(a,b){return{desc:{desc:a.desc,img:a.img,reliability:a.reliability,time:a.time,type:a.pattern_icon_title,candle:a.candle,category:b}}}function d(a){var d,e,f,g,h,i=[],j=JSON.parse(a),k=-1,l=m.attr("data-portfolio_id")||"",o=!!l,q="portfolio"+l,r=l?", "+l:"",s=o?9:7;b(),o?Patterns.patternsData[q]={}:Patterns.patternsData={};for(g in j)if(f=j[g],f.length)for(i.push('<tr class="noHover"><td colspan="'+s+'" class="theDay">'+$.capitalizeAll(p[g])+"</td></tr>"),e=0;e<f.length;e++)d=f[e],h=c(d,g),o?Patterns.patternsData[q][++k]=h:Patterns.patternsData[++k]=h,i.push('<tr id="row'+(l?"_"+l+"_":"")+k+'" onclick="Patterns.openDesc('+k+r+');">'),i.push('<td class="flag"><span class="middle ceFlags '+d.flag+'"></span></td>'),i.push('<td class="left bold noWrap"><a title="'+d.full_name+'" href="'+d.link+'">'+d.pair_name+"</a></td>"),o&&i.push('<td class="left">'+d.symbol+"</td>"),i.push('<td class="left">'+d.timeframe+"</td>"),i.push('<td class="left" title="'+d.reliability+'">'+(Patterns.reliabilityIcons["rel/"+d.reliability_val.toLowerCase()]||"")+"</td>"),i.push('<td class="left bold">'+d.pattern_name+"</td>"),i.push('<td class="left">'+d.candle+"</td>"),o&&i.push('<td class="">'+d.time+"</td>"),i.push('<td class="icon" title="'+d.pattern_icon_title+'"><span class="'+d.pattern_icon+'"></span></td></tr>');Object.keys(o?Patterns.patternsData[q]:Patterns.patternsData).length?m.html(i.join("")):m.html(n),$.bindStopProp(m)}function e(a){var b,c=["apply_filter=1"];return l.each(function(){var a=$(this).find("input"),b=a.filter(":checked"),d=b.length?b:a;c=c.concat(d.toArray().map(function(a){return a.getAttribute("name")+"="+a.getAttribute("value")}))}),$("#pairs_table .js-techInstrumentLabel").each(function(){b=$(this).data("instrumentId"),b&&c.push("options[currencies][]="+b)}),a&&c.push("portfolioId="+a),window.getPairsInCSVFromLastResults&&c.push("csp_pair_list="+window.getPairsInCSVFromLastResults()),k.find("#csp_pair_list_for_tables").length>0&&c.push("csp_pair_list="+k.find("#csp_pair_list_for_tables").val()),c.join("&")}var f=$(".js-csp-no-results").remove(),g=f.filter("table"),h=a||"",i=!!h,j=i?9:7,k=$("#candleStick_filters"+h),l=k.find(".js-category"),m=$(".js-csp-table"+h+" #patternTableBody"+h),n=$((f.eq(0).html()||"").trim()||(g.length?g:"<table><tr></tr></table>")).find("tr"),o=$('<tr class="noHover"><td colspan="'+j+'" class="center"></td></tr>'),p={emerging:Patterns.texts._candlestick_patterns_emerging_patterns,completed:Patterns.texts._candlestick_patterns_completed_patterns};$(".js-candlestick-filters-submit").click(function(a){o.find("td").text(Patterns.texts._candlestick_patterns_loading_msg),k.slideUp("slow"),m.html(o),$customPairsInput=k.find("input#csp_pair_list_for_tables"),ga("allSitesTracker.send","event","Tables","Candlestick Patterns","Apply Customize"),!$(a.target).hasClass("js-old-service")||$customPairsInput.length&&0!=$customPairsInput.val()?$.ajax("/instruments/Service/cspFilter",{data:e($(a.target).attr("data-portfolio-id")),method:"GET",success:d}):Patterns.loadPatterns()}),$.bindStopProp(m),$("#filterStateAnchor"+h).click(function(){k.slideToggle("slow")})}};