// File: addToPortfolioClass.js
function AddToPortfolioClass(){function a(a,b){window.components.HoverMe&&window.components.HoverMe.setKeepAlive(a,b)}function b(a,b){i[a].forEach(function(a){a(b)})}function c(a){$("[attr-lastrow_addnew]",a).addClass("displayNone"),$("[attr-lastrow_addnew]>a",a).addClass("disabled"),$("[attr-lastrow_createportfolio]",a).removeClass("displayNone"),$("[attr-newprofilename]",a).val("")}function d(){var a=$(".js-just-multipair .js-add-to-watchlist-rows .checkbox:checked").length?"removeClass":"addClass";$(".js-just-multipair .js-addto-portfolios")[a]("disabled")}function e(){setTimeout(function(){$(document).on("click.addToPortfolio",function(d){document.body.contains(d.target)&&0===$(d.target).parent().siblings("[attr-addToPortfolioPop]").length&&0===$(d.target).closest("[attr-addToPortfolioPop]").length&&($("[attr-addToPortfolioPop]").addClass("displayNone"),b("close"),f(),a(d.target,!1),c($(".js-just-multipair")))})},1)}function f(){$(document).off("click.addToPortfolio"),$("body").off("click.portfolioPopup")}var g=this,h=null,i={close:[]};this.buildPortfolio=function(g,i){if(0==i)return overlay.authCompleteAction={type:"addToPortfolio",actionData:{clickSrc:"singleBTN"}},void overlay.overlayLogin();var j=$(".js-just-multipair");j.find(".footer,.content:first").removeClass("displayNone"),j.find(".js-status-message").addClass("displayNone");var k=$(g).closest("[widget-addtoportfolio]"),l=$(k).find("[attr-addToPortfolioPop]"),m=$(l).find("[attr-pre-loading]"),n=$(l).find(".js-add-to-watchlist-rows");h=h||l.attr("pair_ID");var o=l.is(".js-just-multipair");if(c($(".js-just-multipair")),$(m).removeClass("displayNone"),"none"==$(l).css("display")){a(g,!0),e();var p=o?{multiPair:!0}:{pair_ID:h};$(l).removeClass("displayNone"),$.get("/portfolio/getinstrumentprotfolioslist",p,function(a){var b,c="";$(m).addClass("displayNone");for(var e in a)b=a[e].set_disabled,c+='<label title="'+a[e].title+'" class="addRow'+(b?" portfolioFull":"")+'">',c+='<input type="checkbox" attr-checkbox-id="'+a[e].id+'" '+(b?" disabled":"")+' class="checkbox"'+(a[e].is_checked?" checked ":"")+" >",c+="<span>"+a[e].protfolio_name+"</span>",c+=b?"<i>&nbsp;&#40;"+window.addToPortfolioDefinitions._full+"&#41;</i>":"",c+="</label>";n.html(c).removeClass("displayNone"),d(),$("body").on("click.portfolioPopup",function(a){var b=$(a.target);b.is("[attr-addtoportfoliopop]")||b.parents("[attr-addtoportfoliopop]").length||($(l).addClass("displayNone"),o&&$(l).find("input").prop("checked",!1),$(l).find(".js-addto-portfolios").addClass("disabled"),$("body").off("click.portfolioPopup"))})},"json")}else a(g,!1),b("close"),f(),$(l).addClass("displayNone");k.find(".js-close").unbind("click").bind("click",function(){$("[attr-addToPortfolioPop]").addClass("displayNone"),b("close"),f(),a(g,!1),c($(".js-just-multipair"))})},this.showCreatePortfolio=function(a){var b=this,d=$(a).closest("[widget-addtoportfolio]"),e=$(d).find(".js-submit").addClass("disabled");$(d).find("[attr-lastRow_createPortfolio]").addClass("displayNone"),$(d).find("[attr-lastrow_addnew]").removeClass("displayNone"),$(d).find("[attr-newProfileName]").focus().off("keyup.name-validation change.name-validation keydown.press-enter").on("keyup.name-validation change.name-validation",function(){this.value.trim()?e.removeClass("disabled"):e.addClass("disabled")}).on("keydown.press-enter",function(a){var d=a.which||a.keyCode;13===d&&(b.createPortfolio(this),c($(".js-just-multipair")))})},this.createPortfolio=function(a){var b=$(a).closest("[widget-addtoportfolio]"),c=$(b).find("[attr-newProfileName]").val().trim();if(c){$(b).find("[attr-addToPortfolioPop]");$(a).parent().addClass("displayNone"),$(b).find("[attr-lastRow_loading]").removeClass("displayNone"),$.post("/portfolio/addtoinstrumentportfolioajax",{action:"createPortfolio",portfolioName:c,pair_ID:h},function(a){$(b).find(".js-add-to-watchlist-rows").append(a),$(b).find("[attr-lastRow_loading]").addClass("displayNone"),$(b).find("[attr-lastRow_createPortfolio]").removeClass("displayNone"),$(b).find("[attr-newProfileName]").val("")},"text")}},this.addRemoveToPortfolio=function(a,b,c,d){var e=a?"addToPortfolio":"removeFromPortfolio",f=$.Deferred();return $.post("/portfolio/addtoinstrumentportfolioajax",{pair_IDS:c,action:e,portfolioId:b},function(a){f.resolve(b,d)},"text"),f.promise()},this.bindPortfolioPopup=function(a){this.setPairId(null),a||(a=$(document)),a.find(".js-add-to-watchlist-rows").on("click",".addRow",function(b){var e,f=$(this).closest(".js-just-multipair").length,i=$("input",this).attr("attr-checkbox-id"),j=$(this).hasClass("portfolioFull"),k=!$(b.target).is("input.checkbox");if(!k){if(a.find("#portfolioatto-loading"+i).length||j)return b.preventDefault(),!1;var l=$("input",this)[0];if($(b.target).is("input")||(l.checked=!l.checked),e=l.checked,f){var m=$(".js-just-multipair");c(m),d()}else l=$("input",this),l.addClass("displayNone"),l.before('<span id="portfolioatto-loading'+i+'" class="loading-responsive small-circle inlineblock"></span>'),h=h||$(this).closest(".js-just-instrument").attr("pair_id"),g.addRemoveToPortfolio(e,i,h,l).then(function(a,b){$("#portfolioatto-loading"+a).remove(),b.removeClass("displayNone")})}}),a.find(".js-addto-portfolios").click(function(b){var c=[];a.find(".js-add-to-watchlist-rows .addRow>input:checked").each(function(){c.push($(this).attr("attr-checkbox-id"))});var d=a.find(".js-just-multipair").attr("pair_ids");c.length&&(c=c.join(","),g.addRemoveToPortfolio(!0,c,d,null).then(function(b){var c=a.find(".js-just-multipair");c.find(".footer,.content:first").addClass("displayNone"),c.find(".js-status-message").removeClass("displayNone"),c.parents(".js-recent-quotes").length&&ga("allSitesTracker.send","event","Recent Quotes","Add to Watchlist")}))}),d()},this.setPairId=function(a){h=a||null},this.subscribe=function(a,b){return i[a]&&i[a].push(b),this}}var addToPortfolioClass=new AddToPortfolioClass;addToPortfolioClass.bindPortfolioPopup();